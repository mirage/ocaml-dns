<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Dns_trie (dns-server.Dns_trie)</title><link rel="stylesheet" href="../../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 1.5.2"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div class="content"><header><nav><a href="../index.html">Up</a> – <a href="../index.html">dns-server</a> &#x00BB; Dns_trie</nav><h1>Module <code>Dns_trie</code></h1><p>Prefix tree data structure for domain names</p><p>The key is a <code>Dns_name</code>, whereas the value may be any resource record. The representation is a tree, where the edges are domain name labels, and the nodes carry a <span class="xref-unresolved" title="unresolved reference to &quot;Dns_map.t&quot;"><span>resource map</span></span>. Some special treatment is applied for zones, which must have a start of authority entry and a set of name servers. End of authority, also known as delegation, is supported. Aliases (canonical names, CNAME records) are also supported.</p><p>The data structure tries to preserve invariants recommended by the domain name system, such as that for any name there may either be an alias or any other record, there must be a SOA record, and multiple NS records for an authoritative zone, a resource type must have entries of the given type (no NS record for A type, the ttl for all resource records of a rrset is the same.</p><nav class="toc"><ul><li><a href="#abstract-trie-type">Abstract trie type</a></li><li><a href="#operations-to-modify-the-trie">Operations to modify the trie</a></li><li><a href="#checking-invariants">Checking invariants</a></li><li><a href="#lookup">Lookup</a></li></ul></nav></header><section><header><h3 id="abstract-trie-type"><a href="#abstract-trie-type" class="anchor"></a>Abstract trie type</h3></header><dl><dt class="spec type" id="type-t"><a href="#type-t" class="anchor"></a><code><span class="keyword">type</span> t</code></dt><dd><p>The type of the trie.</p></dd></dl><dl><dt class="spec value" id="val-pp"><a href="#val-pp" class="anchor"></a><code><span class="keyword">val</span> pp : <span><a href="index.html#type-t">t</a> Fmt.t</span></code></dt><dd><p><code>pp ppf t</code> pretty prints <code>t</code> to <code>ppf</code>.</p></dd></dl><dl><dt class="spec value" id="val-empty"><a href="#val-empty" class="anchor"></a><code><span class="keyword">val</span> empty : <a href="index.html#type-t">t</a></code></dt><dd><p><code>empty</code> is the empty trie.</p></dd></dl><dl><dt class="spec value" id="val-equal"><a href="#val-equal" class="anchor"></a><code><span class="keyword">val</span> equal : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> bool</code></dt><dd><p><code>equal a b</code> compares <code>a</code> with <code>b</code>.</p></dd></dl></section><section><header><h3 id="operations-to-modify-the-trie"><a href="#operations-to-modify-the-trie" class="anchor"></a>Operations to modify the trie</h3></header><dl><dt class="spec value" id="val-insert_map"><a href="#val-insert_map" class="anchor"></a><code><span class="keyword">val</span> insert_map : <span><a href="../../dns/Dns/index.html#module-Rr_map">Dns.Rr_map</a>.t Domain_name.Map.t</span> <span>&#45;&gt;</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="index.html#type-t">t</a></code></dt><dd><p><code>insert_map m t</code> inserts all elements of the domain name map <code>m</code> into <code>t</code>, potentially existing are unioned with <span class="xref-unresolved" title="unresolved reference to &quot;Rr_map.unionee&quot;"><code>Rr_map</code>.unionee</span>.</p></dd></dl><dl><dt class="spec value" id="val-replace_map"><a href="#val-replace_map" class="anchor"></a><code><span class="keyword">val</span> replace_map : <span><a href="../../dns/Dns/index.html#module-Rr_map">Dns.Rr_map</a>.t Domain_name.Map.t</span> <span>&#45;&gt;</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="index.html#type-t">t</a></code></dt><dd><p><code>replace_map m t</code> replaces in the trie <code>t</code> all existing bindings of the domain name map <code>m</code> with the provided map.</p></dd></dl><dl><dt class="spec value" id="val-remove_map"><a href="#val-remove_map" class="anchor"></a><code><span class="keyword">val</span> remove_map : <span><a href="../../dns/Dns/index.html#module-Rr_map">Dns.Rr_map</a>.t Domain_name.Map.t</span> <span>&#45;&gt;</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="index.html#type-t">t</a></code></dt><dd><p><code>remove_map m t</code> removes all elements of the domain name map <code>m</code> from <code>t</code>.</p></dd></dl><dl><dt class="spec value" id="val-insert"><a href="#val-insert" class="anchor"></a><code><span class="keyword">val</span> insert : <span><span class="type-var">'a</span> Domain_name.t</span> <span>&#45;&gt;</span> <span><span class="type-var">'b</span> <a href="../../dns/Dns/index.html#module-Rr_map">Dns.Rr_map</a>.key</span> <span>&#45;&gt;</span> <span class="type-var">'b</span> <span>&#45;&gt;</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="index.html#type-t">t</a></code></dt><dd><p><code>insert n k v t</code> inserts <code>k, v</code> under <code>n</code> in <code>t</code>. Existing entries are unioneed with <span class="xref-unresolved" title="unresolved reference to &quot;Rr_map.union_rr&quot;"><code>Rr_map</code>.union_rr</span>.</p></dd></dl><dl><dt class="spec value" id="val-replace"><a href="#val-replace" class="anchor"></a><code><span class="keyword">val</span> replace : <span><span class="type-var">'a</span> Domain_name.t</span> <span>&#45;&gt;</span> <span><span class="type-var">'b</span> <a href="../../dns/Dns/index.html#module-Rr_map">Dns.Rr_map</a>.key</span> <span>&#45;&gt;</span> <span class="type-var">'b</span> <span>&#45;&gt;</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="index.html#type-t">t</a></code></dt><dd><p><code>replace n k v t</code> inserts <code>k, v</code> under <code>n</code> in <code>t</code>. Existing entries are replaced.</p></dd></dl><dl><dt class="spec value" id="val-remove"><a href="#val-remove" class="anchor"></a><code><span class="keyword">val</span> remove : <span><span class="type-var">'a</span> Domain_name.t</span> <span>&#45;&gt;</span> <span><span class="type-var">'b</span> <a href="../../dns/Dns/index.html#module-Rr_map">Dns.Rr_map</a>.key</span> <span>&#45;&gt;</span> <span class="type-var">'b</span> <span>&#45;&gt;</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="index.html#type-t">t</a></code></dt><dd><p><code>remove k ty v t</code> removes <code>ty, v</code> from <code>t</code> at <code>k</code>. Beware, this may lead to a <code>t</code> where the initially mentioned invariants are violated.</p></dd></dl><dl><dt class="spec value" id="val-remove_ty"><a href="#val-remove_ty" class="anchor"></a><code><span class="keyword">val</span> remove_ty : <span><span class="type-var">'a</span> Domain_name.t</span> <span>&#45;&gt;</span> <span><span class="type-var">'b</span> <a href="../../dns/Dns/index.html#module-Rr_map">Dns.Rr_map</a>.key</span> <span>&#45;&gt;</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="index.html#type-t">t</a></code></dt><dd><p><code>remove_ty k ty t</code> removes <code>ty</code> from <code>t</code> at <code>k</code>. Beware, this may lead to a <code>t</code> where the initially mentioned invariants are violated.</p></dd></dl><dl><dt class="spec value" id="val-remove_all"><a href="#val-remove_all" class="anchor"></a><code><span class="keyword">val</span> remove_all : <span><span class="type-var">'a</span> Domain_name.t</span> <span>&#45;&gt;</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="index.html#type-t">t</a></code></dt><dd><p><code>remove_all k t</code> removes all entries of <code>k</code> in <code>t</code>. Beware, this may lead to a <code>t</code> where the initially mentioned invariants are violated.</p></dd></dl><dl><dt class="spec value" id="val-remove_zone"><a href="#val-remove_zone" class="anchor"></a><code><span class="keyword">val</span> remove_zone : <span><span class="type-var">'a</span> Domain_name.t</span> <span>&#45;&gt;</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="index.html#type-t">t</a></code></dt><dd><p><code>remove_zone name t</code> remove the zone <code>name</code> from <code>t</code>, retaining subzones (entries with <code>Soa</code> records). This removes as well any delegations.</p></dd></dl></section><section><header><h3 id="checking-invariants"><a href="#checking-invariants" class="anchor"></a>Checking invariants</h3></header><dl><dt class="spec type" id="type-zone_check"><a href="#type-zone_check" class="anchor"></a><code><span class="keyword">type</span> zone_check</code> = <code>[ </code><table class="variant"><tr id="type-zone_check.Missing_soa" class="anchored"><td class="def constructor"><a href="#type-zone_check.Missing_soa" class="anchor"></a><code>| </code><code>`Missing_soa <span class="keyword">of</span> <span><span>[ `raw ]</span> Domain_name.t</span></code></td></tr><tr id="type-zone_check.Cname_other" class="anchored"><td class="def constructor"><a href="#type-zone_check.Cname_other" class="anchor"></a><code>| </code><code>`Cname_other <span class="keyword">of</span> <span><span>[ `raw ]</span> Domain_name.t</span></code></td></tr><tr id="type-zone_check.Bad_ttl" class="anchored"><td class="def constructor"><a href="#type-zone_check.Bad_ttl" class="anchor"></a><code>| </code><code>`Bad_ttl <span class="keyword">of</span> <span><span>[ `raw ]</span> Domain_name.t</span> * <a href="../../dns/Dns/index.html#module-Rr_map">Dns.Rr_map</a>.b</code></td></tr><tr id="type-zone_check.Empty" class="anchored"><td class="def constructor"><a href="#type-zone_check.Empty" class="anchor"></a><code>| </code><code>`Empty <span class="keyword">of</span> <span><span>[ `raw ]</span> Domain_name.t</span> * <a href="../../dns/Dns/Rr_map/index.html#type-k">Dns.Rr_map.k</a></code></td></tr><tr id="type-zone_check.Missing_address" class="anchored"><td class="def constructor"><a href="#type-zone_check.Missing_address" class="anchor"></a><code>| </code><code>`Missing_address <span class="keyword">of</span> <span><span>[ `host ]</span> Domain_name.t</span></code></td></tr><tr id="type-zone_check.Soa_not_ns" class="anchored"><td class="def constructor"><a href="#type-zone_check.Soa_not_ns" class="anchor"></a><code>| </code><code>`Soa_not_ns <span class="keyword">of</span> <span><span>[ `raw ]</span> Domain_name.t</span></code></td></tr><tr id="type-zone_check.Soa_not_a_host" class="anchored"><td class="def constructor"><a href="#type-zone_check.Soa_not_a_host" class="anchor"></a><code>| </code><code>`Soa_not_a_host <span class="keyword">of</span> <span><span>[ `raw ]</span> Domain_name.t</span> * string</code></td></tr></table><code> ]</code></dt></dl><dl><dt class="spec value" id="val-pp_zone_check"><a href="#val-pp_zone_check" class="anchor"></a><code><span class="keyword">val</span> pp_zone_check : <span><a href="index.html#type-zone_check">zone_check</a> Fmt.t</span></code></dt><dd><p><code>pp_err ppf err</code> pretty prints the error <code>err</code>.</p></dd></dl><dl><dt class="spec value" id="val-check"><a href="#val-check" class="anchor"></a><code><span class="keyword">val</span> check : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <span><span>(unit, <a href="index.html#type-zone_check">zone_check</a>)</span> Stdlib.result</span></code></dt><dd><p><code>check t</code> checks all invariants.</p></dd></dl></section><section><header><h3 id="lookup"><a href="#lookup" class="anchor"></a>Lookup</h3></header><dl><dt class="spec type" id="type-e"><a href="#type-e" class="anchor"></a><code><span class="keyword">type</span> e</code> = <code>[ </code><table class="variant"><tr id="type-e.Delegation" class="anchored"><td class="def constructor"><a href="#type-e.Delegation" class="anchor"></a><code>| </code><code>`Delegation <span class="keyword">of</span> <span><span>[ `raw ]</span> Domain_name.t</span> * <span>(int32 * Domain_name.Host_set.t)</span></code></td></tr><tr id="type-e.EmptyNonTerminal" class="anchored"><td class="def constructor"><a href="#type-e.EmptyNonTerminal" class="anchor"></a><code>| </code><code>`EmptyNonTerminal <span class="keyword">of</span> <span><span>[ `raw ]</span> Domain_name.t</span> * <a href="../../dns/Dns/Soa/index.html#type-t">Dns.Soa.t</a></code></td></tr><tr id="type-e.NotAuthoritative" class="anchored"><td class="def constructor"><a href="#type-e.NotAuthoritative" class="anchor"></a><code>| </code><code>`NotAuthoritative</code></td></tr><tr id="type-e.NotFound" class="anchored"><td class="def constructor"><a href="#type-e.NotFound" class="anchor"></a><code>| </code><code>`NotFound <span class="keyword">of</span> <span><span>[ `raw ]</span> Domain_name.t</span> * <a href="../../dns/Dns/Soa/index.html#type-t">Dns.Soa.t</a></code></td></tr></table><code> ]</code></dt><dd><p>The type of lookup errors.</p></dd></dl><dl><dt class="spec value" id="val-pp_e"><a href="#val-pp_e" class="anchor"></a><code><span class="keyword">val</span> pp_e : <span><a href="index.html#type-e">e</a> Fmt.t</span></code></dt><dd><p><code>pp_e ppf e</code> pretty-prints <code>e</code> on <code>ppf</code>.</p></dd></dl><dl><dt class="spec value" id="val-zone"><a href="#val-zone" class="anchor"></a><code><span class="keyword">val</span> zone : <span><span class="type-var">'a</span> Domain_name.t</span> <span>&#45;&gt;</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <span><span>(<span><span>[ `raw ]</span> Domain_name.t</span> * <a href="../../dns/Dns/Soa/index.html#type-t">Dns.Soa.t</a>, <a href="index.html#type-e">e</a>)</span> Stdlib.result</span></code></dt><dd><p><code>zone k t</code> returns either the zone and soa for <code>k</code> in <code>t</code>, or an error.</p></dd></dl><dl><dt class="spec value" id="val-lookup_with_cname"><a href="#val-lookup_with_cname" class="anchor"></a><code><span class="keyword">val</span> lookup_with_cname : <span><span class="type-var">'a</span> Domain_name.t</span> <span>&#45;&gt;</span> <span><span class="type-var">'b</span> <a href="../../dns/Dns/index.html#module-Rr_map">Dns.Rr_map</a>.key</span> <span>&#45;&gt;</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <span><span>(<a href="../../dns/Dns/index.html#module-Rr_map">Dns.Rr_map</a>.b * <span>(<span><span>[ `raw ]</span> Domain_name.t</span> * int32 * Domain_name.Host_set.t)</span>, <a href="index.html#type-e">e</a>)</span> Stdlib.result</span></code></dt><dd><p><code>lookup_with_cname k ty t</code> finds <code>k, ty</code> in <code>t</code>. It either returns the found resource record set and authority information, a cname alias and authority information, or an error.</p></dd></dl><dl><dt class="spec value" id="val-lookup"><a href="#val-lookup" class="anchor"></a><code><span class="keyword">val</span> lookup : <span><span class="type-var">'a</span> Domain_name.t</span> <span>&#45;&gt;</span> <span><span class="type-var">'b</span> <a href="../../dns/Dns/index.html#module-Rr_map">Dns.Rr_map</a>.key</span> <span>&#45;&gt;</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <span><span>(<span class="type-var">'b</span>, <a href="index.html#type-e">e</a>)</span> Stdlib.result</span></code></dt><dd><p><code>lookup k ty t</code> finds <code>k, ty</code> in <code>t</code>, which may lead to an error.</p></dd></dl><dl><dt class="spec value" id="val-lookup_any"><a href="#val-lookup_any" class="anchor"></a><code><span class="keyword">val</span> lookup_any : <span><span class="type-var">'a</span> Domain_name.t</span> <span>&#45;&gt;</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <span><span>(<a href="../../dns/Dns/index.html#module-Rr_map">Dns.Rr_map</a>.t * <span>(<span><span>[ `raw ]</span> Domain_name.t</span> * int32 * Domain_name.Host_set.t)</span>, <a href="index.html#type-e">e</a>)</span> Stdlib.result</span></code></dt><dd><p><code>lookup_any k t</code> looks up all resource records of <code>k</code> in <code>t</code>, and returns that and the authority information.</p></dd></dl><dl><dt class="spec value" id="val-lookup_glue"><a href="#val-lookup_glue" class="anchor"></a><code><span class="keyword">val</span> lookup_glue : <span><span class="type-var">'a</span> Domain_name.t</span> <span>&#45;&gt;</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <span><span>(int32 * <a href="../../dns/Dns/Rr_map/index.html#module-Ipv4_set">Dns.Rr_map.Ipv4_set</a>.t)</span> option</span> * <span><span>(int32 * <a href="../../dns/Dns/Rr_map/index.html#module-Ipv6_set">Dns.Rr_map.Ipv6_set</a>.t)</span> option</span></code></dt><dd><p><code>lookup_glue k t</code> finds glue records (A, AAAA) for <code>k</code> in <code>t</code>. It ignores potential DNS invariants, e.g. that there is no surrounding zone.</p></dd></dl><dl><dt class="spec value" id="val-entries"><a href="#val-entries" class="anchor"></a><code><span class="keyword">val</span> entries : <span><span class="type-var">'a</span> Domain_name.t</span> <span>&#45;&gt;</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <span><span>(<a href="../../dns/Dns/Soa/index.html#type-t">Dns.Soa.t</a> * <span><a href="../../dns/Dns/index.html#module-Rr_map">Dns.Rr_map</a>.t Domain_name.Map.t</span>, <a href="index.html#type-e">e</a>)</span> Stdlib.result</span></code></dt><dd><p><code>entries name t</code> returns either the SOA and all entries for the requested <code>name</code>, or an error.</p></dd></dl><dl><dt class="spec value" id="val-fold"><a href="#val-fold" class="anchor"></a><code><span class="keyword">val</span> fold : <span><span class="type-var">'a</span> <a href="../../dns/Dns/index.html#module-Rr_map">Dns.Rr_map</a>.key</span> <span>&#45;&gt;</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <span>(<span><span>[ `raw ]</span> Domain_name.t</span> <span>&#45;&gt;</span> <span class="type-var">'a</span> <span>&#45;&gt;</span> <span class="type-var">'b</span> <span>&#45;&gt;</span> <span class="type-var">'b</span>)</span> <span>&#45;&gt;</span> <span class="type-var">'b</span> <span>&#45;&gt;</span> <span class="type-var">'b</span></code></dt><dd><p><code>fold key t f acc</code> calls <code>f</code> with <code>dname value acc</code> element in <code>t</code>.</p></dd></dl><dl><dt class="spec value" id="val-diff"><a href="#val-diff" class="anchor"></a><code><span class="keyword">val</span> diff : <span><span class="type-var">'a</span> Domain_name.t</span> <span>&#45;&gt;</span> <a href="../../dns/Dns/Soa/index.html#type-t">Dns.Soa.t</a> <span>&#45;&gt;</span> <span>old:<a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <span><span>(<a href="../../dns/Dns/Soa/index.html#type-t">Dns.Soa.t</a> * <span>[ `Empty <span><span>| `Full</span> of <a href="../../dns/Dns/Name_rr_map/index.html#type-t">Dns.Name_rr_map.t</a></span> <span><span>| `Difference</span> of <a href="../../dns/Dns/Soa/index.html#type-t">Dns.Soa.t</a> * <a href="../../dns/Dns/Name_rr_map/index.html#type-t">Dns.Name_rr_map.t</a> * <a href="../../dns/Dns/Name_rr_map/index.html#type-t">Dns.Name_rr_map.t</a></span> ]</span>, <span>[&gt; <span>`Msg of string</span> ]</span>)</span> Stdlib.result</span></code></dt><dd><p><code>diff zone soa ~old trie</code> computes the difference of <code>zone</code> in <code>old</code> and <code>trie</code>, and returns either <code>`Empty</code> if <code>soa</code> is equal or newer than the one in <code>trie</code>, <code>`Full</code> (the same as <code>entries</code>) if <code>zone</code> is not present in <code>old</code>, or <code>`Difference (old_soa, deleted, added)</code>. Best used with IXFR. An error occurs if <code>zone</code> is not present in <code>trie</code>.</p></dd></dl></section></div></body></html>